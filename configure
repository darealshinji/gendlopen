#!/bin/sh

check_cxx_flag()
{
    if [ "x$1" = "x1" ]; then
        flag=""
    fi

    if [ "x$flag" = "x" ]; then
        printf "check if $CXX accepts $2 ... "

        echo '' > test.cpp
        echo "$CXX -Werror $2 -c test.cpp" >> test.log
        $CXX -Werror $2 -c test.cpp >/dev/null 2>>test.log
        ret=$?
        echo '' >> test.log

        rm -f test.cpp test.o test.obj

        if [ $ret -eq 0 ]; then
            flag="$2"
            echo "yes"
        else
            echo "no"
        fi
    fi
}

check_std_version()
{
    if [ "x$1" = "xmsvc" ]; then
        check_cxx_flag 1 -std:c++23
        check_cxx_flag 0 -std:c++20
    else
        check_cxx_flag 1 -std=gnu++23
        check_cxx_flag 0 -std=c++23
        check_cxx_flag 0 -std=gnu++20
        check_cxx_flag 0 -std=c++20
    fi

    if [ "x$flag" = "x" ]; then
        echo "error: C++20 or newer is required"
        exit 1
    fi

    std="$flag"
}

use_def_cflags="yes"
use_def_cxxflags="yes"
use_def_cppflags="yes"
use_def_ldflags="yes"
check_xxd="yes"

rm -f test.log

# parse arguments
for i in "$@"
do
case $i in
    --help|-h)
        cat <<EOL
usage: $0 OPTIONS

set compilers:
    cc=..  cxx=..  ccbuild=..

host triplet:
    host=..

set clang-cl:
    cl=..

override flags:
    cflags=..  cxxflags=..  cppflags=..  ldlfags=..

append extra flags:
    xcflags=..  xcxxflags=..  xcppflags=..  xldlfags=..

set ar tool:
    ar=..

set gendlopen tool used for cross-compiling tests:
    gdo=..

don't search for xxd tool:
    --no-xxd

print this help:
    -h, --help

EOL
        exit 0
        ;;

    cc=*)
        CC="${i#*=}"
        ;;
    cxx=*)
        CXX="${i#*=}"
        ;;
    ccbuild=*)
        CCBUILD="${i#*=}"
        ;;
    host=*)
        HOST="${i#*=}"
        ;;
    cl=*)
        CL="${i#*=}"
        ;;
    ar=*)
        AR="${i#*=}"
        ;;
    gdo=*)
        GENDLOPEN="${i#*=}"
        ;;
    cflags=*)
        CFLAGS="${i#*=}"
        use_def_cflags="no"
        ;;
    cxxflags=*)
        CXXFLAGS="${i#*=}"
        use_def_cxxflags="no"
        ;;
    cppflags=*)
        CPPFLAGS="${i#*=}"
        use_def_cppflags="no"
        ;;
    ldflags=*)
        LDFLAGS="${i#*=}"
        use_def_ldflags="no"
        ;;
    xcflags=*)
        XCFLAGS="${i#*=}"
        ;;
    xcxxflags=*)
        XCXXFLAGS="${i#*=}"
        ;;
    xcppflags=*)
        XCPPFLAGS="${i#*=}"
        ;;
    xldflags=*)
        XLDFLAGS="${i#*=}"
        ;;
    --no-xxd)
        check_xxd="no"
        ;;

    *)
        echo "error: unknown option: $i"
        exit 1
        ;;
esac
done

# xxd
GEN_TEMPL="gen_template_h"
if [ "x$check_xxd" = "xyes" ]; then
    xxd -v 2>/dev/null >/dev/null

    if [ $? -eq 0 ]; then
        GEN_TEMPL="gen_template_h.sh"
    fi
fi

# clang-cl / MSVC
if [ "x$CL" != "x" ]; then
    CC="$CL"
    CXX="$CL"
fi

# host triplet
if [ "x$HOST" != "x" ]; then
    HOST="${HOST}-"
fi

# host ar
if [ "x$AR" = "x" ]; then
    AR="${HOST}ar"
fi

# host C
if [ "x$CC" = "x" ]; then
    gcc --version 2>/dev/null >/dev/null

    if [ $? -eq 0 ]; then
        CC="${HOST}gcc"
    else
        CC="${HOST}cc"
    fi
fi

# host C++
if [ "x$CXX" = "x" ]; then
    g++ --version 2>/dev/null >/dev/null

    if [ $? -eq 0 ]; then
        CXX="${HOST}g++"
    else
        CXX="${HOST}c++"
    fi
fi

# build C
if [ "x$CCBUILD" = "x" ]; then
    gcc --version 2>/dev/null >/dev/null

    if [ $? -eq 0 ]; then
        CCBUILD="gcc"
    else
        CCBUILD="cc"
    fi
fi

# check target platform
if [ "x$CL" != "x" ]; then
    # MSVC
    def_cppflags="-DWIN32_LEAN_AND_MEAN"
    def_cflags="-W3 -O2"
    def_cxxflags="-W3 -O2 -EHsc" #-std:c++latest
    def_ldflags="-link -subsystem:console -release"
    check_std_version msvc

    EXEEXT=".exe"
    DLL="libhelloworld-0.dll"
    DLL_CFLAGS="-DBUILDING_DLL -LD"
    UNICODE_FLAGS="-DUNICODE -D_UNICODE"
elif $CC -dumpmachine 2>/dev/null | grep mingw >/dev/null ; then
    # MinGW
    def_cppflags="-DWIN32_LEAN_AND_MEAN"
    def_cflags="-Wall -Wextra -O3"
    def_cxxflags="-Wall -Wextra -O3"
    check_std_version

    EXEEXT=".exe"
    DLL="libhelloworld-0.dll"
    DLL_CFLAGS="-DBUILDING_DLL"
    DLL_LDFLAGS="-shared"
    UNICODE_FLAGS="-DUNICODE -D_UNICODE -municode"

    check_cxx_flag 1 -std=c++11
    test_cxx11="$flag"
else
    # *nix
    if $CXX -dumpmachine 2>/dev/null | grep gnu >/dev/null ; then
        def_cppflags="-D_GNU_SOURCE"
    fi
    def_cflags="-Wall -Wextra -O3"
    def_cxxflags="-Wall -Wextra -O3"
    check_std_version

    # library name
    if $CC -dumpmachine 2>/dev/null | grep darwin >/dev/null ; then
        DLL="libhelloworld.0.dylib"
    elif $CC -dumpmachine 2>/dev/null | grep aix >/dev/null ; then
        DLL="libhelloworld.a"
    else
        DLL="libhelloworld.so.0"
    fi

    DLL_CFLAGS="-fPIC"
    DLL_LDFLAGS="-shared"
    TEST_LDFLAGS="-Wl,-rpath,'\$\$ORIGIN'"

    check_cxx_flag 1 -std=c++11
    test_cxx11="$flag"
fi

# set default flags
if [ $use_def_cppflags = "yes" ]; then
    CPPFLAGS="$def_cppflags"
fi
if [ $use_def_cflags = "yes" ]; then
    CFLAGS="$def_cflags"
fi
if [ $use_def_cxxflags = "yes" ]; then
    CXXFLAGS="$def_cxxflags $std"
    TEST_CXXFLAGS="$def_cxxflags $test_cxx11"
fi
if [ $use_def_ldflags = "yes" ]; then
    LDFLAGS="$def_ldflags"
fi

# set extra flags
if [ "x$XCPPFLAGS" != "x" ]; then
    CPPFLAGS="$CPPFLAGS $XCPPFLAGS"
fi
if [ "x$XCFLAGS" != "x" ]; then
    CFLAGS="$CFLAGS $XCFLAGS"
fi
if [ "x$XCXXFLAGS" != "x" ]; then
    CXXFLAGS="$CXXFLAGS $XCXXFLAGS"
fi
if [ "x$XLDFLAGS" != "x" ]; then
    LDFLAGS="$LDFLAGS $XLDFLAGS"
fi

# test CXXFLAGS
if [ $use_def_cxxflags != "yes" ]; then
    TEST_CXXFLAGS="$CXXFLAGS"
fi

# gendlopen tool
if [ "x$GENDLOPEN" = "x" ]; then
    GENDLOPEN="$PWD/src/gendlopen$EXEEXT"
fi

# output

cat <<EOF > settings.mk

CC            = $CC
CXX           = $CXX
CCBUILD       = $CCBUILD
AR            = $AR

EXEEXT        = $EXEEXT
GENDLOPEN     = $GENDLOPEN
GEN_TEMPL     = $GEN_TEMPL

CFLAGS        = $CFLAGS $CPPFLAGS
CXXFLAGS      = $CXXFLAGS $CPPFLAGS
LDFLAGS       = $LDFLAGS

DLL           = $DLL
UNICODE_FLAGS = $UNICODE_FLAGS
DLL_CFLAGS    = $DLL_CFLAGS
DLL_LDFLAGS   = $DLL_LDFLAGS

TEST_CFLAGS   = $CFLAGS $CPPFLAGS
TEST_CXXFLAGS = $TEST_CXXFLAGS $CPPFLAGS
TEST_LDFLAGS  = $LDFLAGS $TEST_LDFLAGS

EOF

echo ""
echo "create Makefile"
cat settings.mk Makefile.in > Makefile

echo "create src/Makefile"
cat settings.mk src/Makefile.in > src/Makefile

echo "create test/Makefile"
cat settings.mk test/Makefile.in > test/Makefile

cat settings.mk
rm settings.mk
