# Input format

gendlopen reads C prototype declarations from text files or STDIN.

Here's how the input text format must be:
 * all symbols that should be loaded must be listed as C-style prototypes, ending on semi-colon (;)
 * comments, preprocessor lines and simple typedefs are ignored
 * line-breaks are treated as spaces
 * you can set some options on a line beginning with `%option`

This means you can normally copy the declarations verbatim from header files or other documentation.


Get list of symbols
-------------------

If you're unsure which symbols of a library you need to dynamically load you can for example
try to link your binary without the library and take a look at the error messages.

Or you can use tools such as `nm`.
For example to list all symbols prefixed with `gtk_` from a binary linked against libgtk
run `nm --dynamic myexecutable | grep gtk_`.

On Windows you can use `dumpbin` from Visual Studio Developer Command Prompt:
`dumpbin /imports myexecutable.exe | findstr gtk_`


Copying these declarations verbatim from i.e. online documentation into a text file:
``` C
guint
gtk_get_major_version (
  void
);

guint
gtk_get_micro_version (
  void
);

guint
gtk_get_minor_version (
  void
);

void
gtk_init (
  int* argc,
  char*** argv
);
```

Since comments, preprocessor lines and simple typedefs are ignored
this would be fine too:
``` C
#include <xyz.h> // ignored!

/* simple typedef ignored */
typedef struct _myOwnStruct myOwnStruct_t;

/*
// gendlopen's parser is relatively simple,
// a more complex struct typedef like this
// would cause issues
typedef struct _myOwnStruct {
    int a;
    char b;
    void *c;
} myOwnStruct_t;
*/

guint gtk_get_major_version (void);
guint gtk_get_micro_version (void);
guint gtk_get_minor_version (void);

// this conditional has no effect
#ifdef USE_GTK_INIT
void gtk_init (int* argc, char*** argv);
#endif
```

However I recommend to keep it simple.
I also prefer to use the file ending `.txt` for the input list to separate it
from regular source code, but it's not a requirement.


Options
-------

You can set some options on lines beginning with `%option` instead of passing
them through command line.

Line splitting and multiple `%option` lines are supported:
```
%option opt1
%option opt2
%option opt3 \
        opt4 \
        opt5
```

Available options:
```
format=<string>
prefix=<string>
library=[<mode>:]<lib>
include=[nq:]<file>
define=<string>
param=[skip|create|read]
no-date
no-pragma-once
line
```

For an explanation look for the corresponding command line options in `gendlopen -full-help`.


Macros
------

Since macros are not supported it's recommended to remove `DLL_EXPORT` macros
from the declarations.

Sometimes declarations come as macros, for example:
``` C
PNG_EXPORT(1, png_uint_32, png_access_version_number, (void));
PNG_EXPORT(2, void, png_set_sig_bytes, (png_structrp png_ptr, int num_bytes));
```

You can use the C preprocessor to format that list.
Save the list above in a temporary file `temp.h` and add a simple `PNG_EXPORT`
macro definition at the top:
``` C
#define PNG_EXPORT(ignored, type, symbol, param)  type symbol param
PNG_EXPORT(1, png_uint_32, png_access_version_number, (void));
PNG_EXPORT(2, void, png_set_sig_bytes, (png_structrp png_ptr, int num_bytes));
```

Use the preprocessor: `gcc -E temp.h > proto.txt` or `cl.exe -E temp.h > proto.txt`

Possible output:
``` C
# 0 "temp.h"
# 0 "<built-in>"
# 0 "<command-line>"
# 1 "/usr/include/stdc-predef.h" 1 3 4
# 0 "<command-line>" 2
# 1 "temp.h"

png_uint_32 png_access_version_number (void);
void png_set_sig_bytes (png_structrp png_ptr, int num_bytes);
```

All lines beginning with `#` are ignored, so this can be used as input.


gcc -aux-info
-------------

Another way to format the input and get a clean list of prototypes is
to use `gcc -aux-info`.

Process `png.h` and save the list as `aux.txt`:
``` sh
echo '#include <png.h>' | gcc -xc -c - -o /dev/null -aux-info aux.txt
```

The output will contain lines like these:
``` C
/* /usr/include/png.h:2545:NC */ extern png_uint_32 png_get_uint_31 (png_const_structrp restrict , png_const_bytep);
/* /usr/include/png.h:2551:NC */ extern void png_save_uint_32 (png_bytep, png_uint_32);
/* /usr/include/png.h:2554:NC */ extern void png_save_int_32 (png_bytep, png_int_32);
```

Be careful: all kind of unwanted symbols from C standard headers are likely to be included too!
And there may be multiple definitions too. Delete all lines you don't need.


Clang AST
---------

Alternatively the input can be an Abstract Syntax Tree generated by Clang:
`clang -Xclang -ast-dump /usr/include/png.h > ast.txt`

Since all kind of unwanted symbols from C standard headers are likely to be
included too, it's recommened to later use gendlopen's command line options
`-P` (symbol prefix) or `-S` (symbol name) to filter the input.
But you can also force to read all symbols with `-ast-all-symbols`.


# Process input

Assuming the following input file `input.txt`:
``` C
guint gtk_get_major_version (void);
guint gtk_get_micro_version (void);
guint gtk_get_minor_version (void);
void gtk_init (int    *argc,
               char ***argv);
```

Calling gendlopen with this file as input will generate a header file and print
it to STDOUT: `gendlopen input.txt`

Reading from STDIN works too if the input filename is a dash:
`cat input.txt | gendlopen -` or `gendlopen - < input.txt`

We can also use the option `-print-symbols` to check which symbols were found:
`gendlopen -print-symbols input.txt` should print a list of all prototypes.

Use `-param=skip` or `-param=create` if parameter names are missing from the prototypes.

You can also filter the input with `-S` or `-P`.
`-S` will pick a specific symbol and `-P` will pick all symbols that start with a specified prefix.

`-Pgtk_get_` for example will pick only symbols prefixed with `gtk_get_` and
`-Sgtk_get_major_version -Sgtk_get_minor_version` will pick only those two symbols.

You can also combine both:
`-Pgtk_get_mi -Sgtk_init` will in this case pick the following three symbols:
```
gtk_get_micro_version
gtk_get_minor_version
gtk_init
```
